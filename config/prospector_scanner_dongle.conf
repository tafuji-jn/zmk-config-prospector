# Prospector Scanner - Dongle Mode overlay (v26)
# BLE Central + USB HID forwarding (on top of scanner mode)

CONFIG_PROSPECTOR_DONGLE_MODE=y

# Disable ZMK BLE peripheral mode - Prospector is a Central, not a keyboard.
# Without this, ZMK_BLE defaults to y and advertises Prospector as a keyboard,
# enables BT_SMP_SC_PAIR_ONLY, and registers auth callbacks that interfere.
# We call bt_enable() ourselves in hid_central.c.
CONFIG_ZMK_BLE=n

# BLE Central
CONFIG_BT_CENTRAL=y
CONFIG_BT_GATT_CLIENT=y
CONFIG_BT_SMP=y
# Disable P256M so PSA routes ECC through MbedTLS builtin.
# This allows --wrap=mbedtls_ecp_check_pubkey to bypass validation.
CONFIG_MBEDTLS_PSA_P256M_DRIVER_ENABLED=n

# Bond storage (normally handled by ZMK_BLE)
CONFIG_BT_SETTINGS=y
CONFIG_SETTINGS=y
CONFIG_NVS=y
CONFIG_FLASH=y
CONFIG_FLASH_MAP=y

CONFIG_BT_MAX_CONN=3
CONFIG_BT_MAX_PAIRED=3
CONFIG_BT_BONDABLE=y
CONFIG_BT_KEYS_OVERWRITE_OLDEST=y
CONFIG_BT_SMP_ALLOW_UNAUTH_OVERWRITE=y
CONFIG_BT_GATT_AUTO_SEC_REQ=y

# USB HID
CONFIG_USB_DEVICE_STACK=y
CONFIG_USB_DEVICE_HID=y
CONFIG_USB_DEVICE_PRODUCT="Prospector Keyboard Dongle"
CONFIG_USB_DEVICE_INITIALIZE_AT_BOOT=y
CONFIG_USB_HID_BOOT_PROTOCOL=y

# USB CDC ACM serial console (for debug logging via printk)
CONFIG_SERIAL=y
CONFIG_CONSOLE=y
CONFIG_UART_CONSOLE=y
CONFIG_USB_CDC_ACM=y

# Reduce log noise to prevent serial output garbling.
# Our own printk diagnostics provide all needed SMP/ECDH info.
CONFIG_BT_SMP_LOG_LEVEL_WRN=y
CONFIG_LOG_DEFAULT_LEVEL=2

# Stack sizes - BT RX needs deep stack for PSA/P256M LESC validation
# Call chain: BT RX → HCI → L2CAP → SMP → bt_pub_key_is_valid → PSA → P256M
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=4096
CONFIG_BT_RX_STACK_SIZE=8192
CONFIG_BT_ATT_TX_COUNT=10
CONFIG_BT_L2CAP_TX_BUF_COUNT=10

# Target keyboard name (empty = first HID device found)
CONFIG_PROSPECTOR_DONGLE_TARGET_NAME="lotom"
