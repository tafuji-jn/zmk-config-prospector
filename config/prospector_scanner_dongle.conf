# Prospector Scanner - Dongle Mode overlay (v34)
# BLE Central + USB HID forwarding (on top of scanner mode)

CONFIG_PROSPECTOR_DONGLE_MODE=y

# Disable ZMK BLE peripheral mode - Prospector is a Central, not a keyboard.
# Without this, ZMK_BLE defaults to y and advertises Prospector as a keyboard,
# enables BT_SMP_SC_PAIR_ONLY, and registers auth callbacks that interfere.
# We call bt_enable() ourselves in hid_central.c.
CONFIG_ZMK_BLE=n

# BLE Central
CONFIG_BT_CENTRAL=y
CONFIG_BT_GATT_CLIENT=y
CONFIG_BT_SMP=y
# Disable P256M so PSA routes ECC through MbedTLS builtin.
# This allows --wrap=mbedtls_ecp_check_pubkey to bypass validation.
CONFIG_MBEDTLS_PSA_P256M_DRIVER_ENABLED=n

# Bond storage (normally handled by ZMK_BLE)
CONFIG_BT_SETTINGS=y
CONFIG_SETTINGS=y
CONFIG_NVS=y
CONFIG_FLASH=y
CONFIG_FLASH_MAP=y

CONFIG_BT_MAX_CONN=3
CONFIG_BT_MAX_PAIRED=3
CONFIG_BT_BONDABLE=y
CONFIG_BT_KEYS_OVERWRITE_OLDEST=y
CONFIG_BT_SMP_ALLOW_UNAUTH_OVERWRITE=y
CONFIG_BT_GATT_AUTO_SEC_REQ=y

# USB HID — single interface with 3 TLCs (keyboard, consumer, mouse).
# Windows creates separate PDOs for each TLC. Same approach as ZMK itself.
# Boot protocol MUST be disabled: it forces bInterfaceProtocol=Keyboard
# which can prevent Windows from recognizing mouse TLC.
CONFIG_USB_DEVICE_STACK=y
CONFIG_USB_DEVICE_HID=y
# Unique PID to bypass Windows HID descriptor cache from previous firmware
CONFIG_USB_DEVICE_PID=0x615F
CONFIG_USB_DEVICE_PRODUCT="Prospector Keyboard Dongle"
# USB is enabled by usb_hid_forwarder AFTER registering the HID interface.
# INITIALIZE_AT_BOOT would enable USB before HID registration, causing the
# host to enumerate without the HID interface.
# CONFIG_USB_DEVICE_INITIALIZE_AT_BOOT=y
# CONFIG_USB_HID_BOOT_PROTOCOL=y
# USB HID polling interval: default 9ms, lower = smoother mouse cursor
CONFIG_USB_HID_POLL_INTERVAL_MS=1

# DIAGNOSTIC: CDC ACM disabled to test pure HID device (no composite).
# If mouse COL03 appears without CDC ACM, the composite device is the issue.
# CONFIG_SERIAL=y
# CONFIG_CONSOLE=y
# CONFIG_UART_CONSOLE=y
# CONFIG_USB_CDC_ACM=y
CONFIG_CONSOLE=n
CONFIG_UART_CONSOLE=n

# Logging: deferred mode, output goes nowhere without CDC ACM but no crash.
CONFIG_LOG_MODE_DEFERRED=y
CONFIG_LOG_DEFAULT_LEVEL=0
CONFIG_LOG_BUFFER_SIZE=1024

# Stack sizes - BT RX needs deep stack for PSA/P256M LESC validation
# Call chain: BT RX → HCI → L2CAP → SMP → bt_pub_key_is_valid → PSA → P256M
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=4096
CONFIG_BT_RX_STACK_SIZE=8192
CONFIG_BT_ATT_TX_COUNT=10
CONFIG_BT_L2CAP_TX_BUF_COUNT=10

# Target keyboard name (empty = first HID device found)
CONFIG_PROSPECTOR_DONGLE_TARGET_NAME="lotom"
